<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ Hàng Của Bạn</title>
    <link rel="stylesheet" href="Gio-hang.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="animation.js"></script>
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
            <div class="container">
                <a class="navbar-brand text-dark fw-bold fs-3" href="/index.html">DREAMS HOME</a>

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link text-uppercase" href="/index.html">Giới thiệu</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link fw-bold dropdown-toggle text-uppercase" href="#" id="navbarDropdown"
                                role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Sản phẩm
                            </a>
                            <ul class="dropdown-menu border-top border-primary border-3"
                                aria-labelledby="navbarDropdown">
                                <li><a class="dropdown-item" href="/San-pham/San-pham-1.html">Chăn</a></li>
                                <li><a class="dropdown-item" href="/San-pham/San-pham-1.html">Gối</a></li>
                                <li><a class="dropdown-item" href="/San-pham/San-pham-1.html">Nệm</a></li>
                                <li><a class="dropdown-item" href="/San-pham/San-pham-1.html">Combo</a></li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-uppercase" href="Gio-hang.html"><i
                                    class="fas fa-shopping-cart"></i> Giỏ hàng</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-uppercase" href="history.html"> Lịch sử đơn hàng</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-uppercase" href="/login-main/index_login.html" id="login-link">
                                <i class="fas fa-user me-1"></i> Đăng nhập
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <h2 style="text-align:center; margin:20px 0;">Giỏ hàng của bạn</h2>

    <div class="cartBox cart-container"></div>



    <div class="cart-summary">
        <h3> Tổng Kết Đơn Hàng</h3>
        <div class="summary-details">
            <div>
                <span>Tạm tính (<span id="total-items-count"></span> sản phẩm):</span>
                <span id="subtotal-display-summary"></span>
            </div>
            <div>
                <span>Giảm giá (<span id="promo-code-used"></span>):</span>
                <span id="discount-display" style="color: var(--danger-color);"></span>
            </div>
            <div>
                <span>Phí vận chuyển:</span>
                <span id="shipping-fee" style="color: var(--accent-color);">Miễn phí</span>
            </div>
        </div>
        <div class="summary-total">
            <span>Tổng cộng:</span>
            <span id="final-total-display" class="final-total"></span>
        </div>
        <button class="checkout-btn" id="checkout-btn">TIẾN HÀNH THANH TOÁN</button>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="animation.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCxZiG2atJ0QXFZq0afg__t_VkMO-RGRvQ",
            authDomain: "hungnhe1-d394c.firebaseapp.com",
            databaseURL: "https://hungnhe1-d394c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "hungnhe1-d394c",
            storageBucket: "hungnhe1-d394c.firebasestorage.app",
            messagingSenderId: "840678788906",
            appId: "1:840678788906:web:a41f28793a3dcc021c1853"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
    </script>
    <script src="login-checking.js"></script>
    <script>
        function renderCart() {
            let cart = JSON.parse(localStorage.getItem("cart")) || [];

            const cartBox = document.querySelector(".cartBox");
            cartBox.innerHTML = "";

            if (cart.length === 0) {
                cartBox.innerHTML = "<h3>Giỏ hàng trống</h3>";
                return;
            }

            cart.forEach(item => {
                cartBox.innerHTML += `
            <div class="cart-item">
                <img src="${item.img}">
                <div class="cart-info">
                    <h3>${item.name}</h3>
                    <p>Giá: ${Number(item.price).toLocaleString()} đ</p>
                    <p>Số lượng: ${item.qty}</p>
                    <p>Tổng: ${(item.price * item.qty).toLocaleString()} đ</p>
                </div>
                <button class="remove-btn" onclick="removeItem('${item.id}')">Xóa</button>
            </div>
        `;
            });

        }
    </script>

    <script>
        // Lấy giỏ hàng từ localStorage
        let cart = JSON.parse(localStorage.getItem("cart")) || [];

        function formatCurrency(num) {
            return num.toLocaleString("vi-VN") + "đ";
        }

        function updateSummary() {
            let totalItems = 0;
            let subtotal = 0;

            cart.forEach(item => {
                totalItems += item.qty;
                subtotal += item.qty * item.price;
            });

            // Cập nhật số lượng sản phẩm
            document.getElementById("total-items-count").innerText = totalItems;

            // Tạm tính
            document.getElementById("subtotal-display-summary").innerText = formatCurrency(subtotal);

            // Giảm giá (nếu không có thì để 0)
            let discount = 0;
            document.getElementById("discount-display").innerText = "-" + formatCurrency(discount);

            // Tổng cộng
            let finalTotal = subtotal - discount;
            document.getElementById("final-total-display").innerText = formatCurrency(finalTotal);
        }

        function removeItem(id) {
            let cart = JSON.parse(localStorage.getItem("cart")) || [];

            // Xóa item theo id
            cart = cart.filter(item => item.id !== id);

            // Lưu lại giỏ hàng mới
            localStorage.setItem("cart", JSON.stringify(cart));

            // Cập nhật cart biến toàn cục nếu bạn dùng
            window.cart = cart;

            // Render lại danh sách và cập nhật hóa đơn
            renderCart();
            updateSummary();
        }

    </script>
    <script>
        document.getElementById("checkout-btn").addEventListener("click", () => {
            const user = auth.currentUser;

            if (!user) {
                alert("Bạn cần đăng nhập để thanh toán.");
                return;
            }

            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            if (cart.length === 0) {
                alert("Giỏ hàng đang trống!");
                return;
            }

            // Tạo ID đơn hàng
            const orderId = "order_" + Date.now();

            // Chuẩn hóa dữ liệu lưu vào database
            const orderData = {
                userId: user.uid,
                time: new Date().toLocaleString("vi-VN"),
                items: cart
            };

            // Lưu vào Firebase
            db.ref("orders/" + orderId).set(orderData)
                .then(() => {
                    // Xóa giỏ hàng sau thanh toán
                    localStorage.removeItem("cart");

                    alert("Thanh toán thành công!");

                    // Chuyển sang lịch sử đơn hàng
                    window.location.href = "history.html";
                })
                .catch(err => {
                    console.error(err);
                    alert("Thanh toán thất bại!");
                });
        });

        document.addEventListener("DOMContentLoaded", () => {
            renderCart();
            updateSummary();
        });
    </script>

</body>

</html>